<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>Pupergrep</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="description" content="">
        <meta name="author" content="">

        <link href="css/bootstrap.css" rel="stylesheet">
        <style type="text/css">
            body {
                padding-top: 60px;
                padding-bottom: 40px;
            }
            .sidebar-nav {
                padding: 9px 0;
            }

            .pupergrep-settings-form input {
                width: 160px;
                height: auto;
                -webkit-box-sizing: border-box;
                -moz-box-sizing: border-box;
                box-sizing: border-box;
            }
            .pupergrep-settings-form input[disabled] {
                width: 106px;
            }

            .control-group > div,
            .control-group > span {
                vertical-align: middle;
            }

            .text-tag,
            .text-button {
                float: none !important;
            }
            .text-button {
                margin-right: 0 !important;
            }
            .text-core {
                display: inline-block;
            }
            .text-tags {
                padding: 5px !important;
            }

            #logs-list li.log {
                cursor: pointer;
            }
        </style>
        <link href="css/bootstrap-responsive.css" rel="stylesheet">
    </head>

    <body>
        <div class="navbar navbar-fixed-top">
            <div class="navbar-inner">
                <div class="container-fluid">
                    <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </a>
                    <a class="brand" href="/">PuperGrep</a>
                </div>
            </div>
        </div>

        <div class="container-fluid">
            <div class="row-fluid">
                <div class="span3">
                    <div class="well sidebar-nav">
                        <div class="nav-list form-horizontal pupergrep-settings-form">
                            <h3>Settings</h3>
                            <div class="control-group">
                                <input type="text" id="buffer-length" value="20" />
                                <span class="help-inline">buffer lines</span>
                            </div>
                            <div class="control-group">
                                <input type="text" id="highlight-items" placeholder="^web" />
                                <span class="help-inline">highlight lines</span>
                            </div>
                            <div class="control-group">
                                <input type="text" id="grep-items" placeholder="^web" />
                                <span class="help-inline">grep lines</span>
                            </div>
                            <div class="control-group">
                                <div class="input-append">
                                    <input type="text" id="font-size" value="13" disabled="disabled"><button class="btn" id="font-size-bigger">+</button><button class="btn" id="font-size-smaller">-</button>
                                </div>
                                <span class="help-inline">px</span>
                            </div>
                            <button class="btn btn-info" id="pause-button" data-paused="0">
                                <i id="pause-icon" class="icon-pause"></i>
                                <span id="pause-text">Pause</span>
                            </button>
                        </div>
                    </div>
                    <div>
                        <ul class="nav nav-pills nav-stacked">
                            <li>
                                <a id="current-link" href="/">Current log link (copy to share or bookmark)</a>
                            </li>
                        </ul>
                    </div>
                    <div class="well sidebar-nav">
                        <ul class="nav nav-list" id="logs-list">
                            <li class="nav-header">Logs</li>
                            <li>
                                <input type="text" id="log-name-filter" placeholder="Filter logs by name regexp.." />
                            </li>
                        </ul>
                    </div>
                </div>
                <div class="span9">
                    <table class="table table-bordered table-striped" id="log-lines">
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <script type="text/javascript" src="/js/jquery.js"></script>
        <script type="text/javascript" src="/js/jquery.textext.js"></script>
        <script type="text/javascript" src="/socket.io/socket.io.js"></script>
        <script type="text/javascript">
            jQuery(document).ready(function() {
                var logLinesTable     = jQuery("#log-lines"),
                    logsListContainer = jQuery("#logs-list"),
                    logsList          = jQuery(),
                    pauseButton       = jQuery("#pause-button"),
                    logNameFilter     = jQuery("#log-name-filter"),
                    fontSizeSelector  = jQuery("#font-size"),
                    currentLink       = jQuery("#current-link"),
                    currentLog        = undefined,
                    bufferLength      = 20,
                    outputPaused      = false,
                    linkSeparator     = '!!!';

                pauseButton.click(function() {
                    var pauseIcon = jQuery("#pause-icon"),
                        pauseText = jQuery("#pause-text");

                    if (!outputPaused) {
                        pauseIcon.removeClass("icon-pause");
                        pauseIcon.addClass("icon-play");
                        pauseText.text("Resume");
                        outputPaused = true;
                        addLogLine("Output paused");
                    } else {
                        pauseIcon.removeClass("icon-play");
                        pauseIcon.addClass("icon-pause");
                        pauseText.text("Pause");
                        outputPaused = false;
                        addLogLine("Output resumed");
                    }
                });

                function rebuildCurrentLink() {
                    var url = "/?";

                    url += "buffer=" + encodeURIComponent(jQuery("#buffer-length").val());
                    if (jQuery("#highlight-items").data('tags'))
                        url += "&highlight=" + encodeURIComponent(jQuery("#highlight-items").data('tags').join(linkSeparator));
                    if (jQuery("#grep-items").data('tags'))
                        url += "&grep=" + encodeURIComponent(jQuery("#grep-items").data('tags').join(linkSeparator));
                    url += "&name-filter=" + encodeURIComponent(jQuery("#log-name-filter").val());
                    url += "&font-size=" + fontSizeSelector.val();

                    if (currentLog) {
                        url += "&log=" + currentLog;
                    }

                    currentLink.prop("href", url);
                }

                jQuery("#buffer-length").change(function() {
                    var self  = jQuery(this),
                        value = parseInt(self.val());

                    if (isNaN(value) || value <= 0) {
                        self.parent().parent().addClass("error");
                    } else {
                        bufferLength = value;
                        self.parent().parent().removeClass("error");
                    }

                    rebuildCurrentLink();
                });

                fontSizeSelector.change(function() {
                    var fontSize = fontSizeSelector.val();
                    if (fontSize >= 8 && fontSize <= 20) {
                        logLinesTable.css("font-size", fontSize + "px");
                        fontSizeSelector.parent().parent().removeClass("error");
                    } else {
                        fontSizeSelector.parent().parent().addClass("error");
                    }

                    rebuildCurrentLink();
                });

                jQuery("#font-size-bigger").click(function() {
                    fontSizeSelector.val(+fontSizeSelector.val() + 1).change();
                });

                jQuery("#font-size-smaller").click(function() {
                    fontSizeSelector.val(+fontSizeSelector.val() - 1).change();
                });

                jQuery('#highlight-items, #grep-items').textext({ plugins : 'tags' });
                jQuery('#highlight-items, #grep-items').textext()[0].getFormData();
                jQuery('#highlight-items, #grep-items').bind('setFormData', function(e, data, isEmpty) {
                    var $target = jQuery(e.target);
                    $target.data('tags', data);
                    rebuildCurrentLink();
                });

                logNameFilter.keyup(function() {
                    logNameFilter.change();
                });

                logNameFilter.change(function() {
                    try {
                        var regexp = new RegExp(logNameFilter.val(), "i");
                        logsList.each(function(index, node) {
                            // slow piece of shit
                            var element = jQuery(node);
                            if (element.data("log-name").match(regexp)) {
                                if (element.is(':hidden')) {
                                    element.show()
                                }
                            } else {
                                if (!element.is(":hidden")) {
                                    element.hide();
                                }
                            }
                        });
                    } catch (e) {
                        console.log(e);
                    }

                    rebuildCurrentLink();
                });

                logsListContainer.delegate("li.log", "click", function() {
                    var element = jQuery(this);

                    logLinesTable.find("tr.log-line").remove();
                    logsListContainer.children("li.log").removeClass("active");

                    element.addClass("active");
                    socket.emit("subscribe", {
                        name: element.data("log-name")
                    });

                    currentLog = element.data("log-name");

                    rebuildCurrentLink();
                });

                (function initFromURI() {
                    function getURLParameter(name) {
                        var value = (RegExp(name + '=' + '(.*?)(&|$)').exec(location.search)||[,null])[1];
                        return value !== null ? decodeURIComponent(value) : value;
                    }

                    var buffer     = getURLParameter("buffer"),
                        log        = getURLParameter("log"),
                        highlight  = getURLParameter("highlight"),
                        grep       = getURLParameter("grep"),
                        nameFilter = getURLParameter("name-filter"),
                        fontSize   = getURLParameter("font-size");

                    if (buffer) {
                        jQuery("#buffer-length").val(buffer).change();
                    }
                    if (highlight) {
                        jQuery("#highlight-items").textext()[0].tags().addTags(highlight.split(linkSeparator));
                    }
                    if (grep) {
                        jQuery("#grep-items").textext()[0].tags().addTags(grep.split(linkSeparator));
                    }
                    if (nameFilter) {
                        jQuery("#log-name-filter").val(nameFilter).change();
                    }
                    if (fontSize) {
                        fontSizeSelector.val(fontSize).change();
                    }
                    if (log) {
                        currentLog = log;
                    }
                })();

                var socket = io.connect(document.location.hostname, {
                    transports: ['xhr-polling'] // bad, bad nginx!
                });

                socket.on("logs", function(data) {
                    var selectLog;

                    logsListContainer.children(".log").remove();

                    jQuery(data.logs).each(function(index, name) {
                        var container = jQuery("<li>"),
                            log       = jQuery("<a>");

                        log.text(name);
                        container.data("log-name", name);
                        container.addClass("log");
                        container.append(log);

                        logsListContainer.append(container);

                        if (name == currentLog) {
                            selectLog = container;
                        }
                    });

                    if (selectLog) {
                        selectLog.click();
                    }

                    logsList = logsListContainer.children("li.log");
                    logNameFilter.change();

                    rebuildCurrentLink();
                });

                function addLogLine(text, isRaw) {
                    var lines,
                        container,
                        line;

                    container = jQuery("<tr>");
                    line      = jQuery("<td>");

                    line.text(text);

                    if (isGrepEnabled()) {
                        if (!isGrepAcceptedLine(text)) {
                            return;
                        }
                    }

                    if (isHighlightedLine(text)) {
                        container.addClass("alert");
                    }

                    container.addClass("log-line");
                    container.append(line);

                    logLinesTable.append(container);

                    while (true) {
                        lines = logLinesTable.find("tr.log-line");
                        if (lines.length > bufferLength) {
                            lines.first().remove();
                        } else {
                            break;
                        }
                    }
                }

                function isHighlightedLine(text) {
                    var tags = jQuery("#highlight-items").data('tags');
                    try {
                        if (tags && tags.length) {
                            for (var i in tags) {
                                var tag = tags[i];
                                if (tag && text.match(new RegExp(tag))) {
                                    return true;
                                }
                            }
                        }
                    } catch (e) {
                        console.log(e);
                    }

                    return false;
                }

                function isGrepEnabled() {
                    var value = jQuery("#grep-items").data('tags');
                    return !!(value && value.length);
                }

                function isGrepAcceptedLine(text) {
                    var tags = jQuery("#grep-items").data('tags');
                    try {
                        if (tags && tags.length) {
                            for (var i in tags) {
                                var tag = tags[i];
                                if (tag && text.match(new RegExp(tag))) {
                                    return true;
                                }
                            }
                        }
                    } catch (e) {
                        console.log(e);
                    }

                    return false;
                }


                socket.on("line", function(data) {
                    if (outputPaused) {
                        return;
                    }

                    addLogLine(data.line);
                });

                socket.on("disconnect", function() {
                    console.log("got disconnect!");
                });

                socket.on("connect", function() {
//                    socket.emit("subscribe", {path: "/tmp/pew"});
                    console.log("connected!");
                });
            });
        </script>
    </body>
</html>
